window.console=window.console||{};window.console.log=window.console.log||function(){};window.Usergrid=window.Usergrid||{};Usergrid=Usergrid||{};Usergrid.SDK_VERSION='0.9.9';(function(){Usergrid.Query=function(method,resource,jsonObj,paramsObj,successCallback,failureCallback){this._method=method;this._resource=resource;this._jsonObj=jsonObj;this._paramsObj=paramsObj;this._successCallback=successCallback;this._failureCallback=failureCallback;this._curl='';this._token=false;this._cursor=null;this._next=null this._previous=[];this._start=0;this._end=0};Usergrid.Query.prototype={setQueryStartTime:function(){this._start=new Date().getTime()},setQueryEndTime:function(){this._end=new Date().getTime()},getQueryTotalTime:function(){var seconds=0;var time=this._end-this._start;try{seconds=((time/10)/60).toFixed(2)}catch(e){return 0}return this.getMethod()+" "+this.getResource()+" - "+seconds+" seconds"},setAllQueryParams:function(method,resource,jsonObj,paramsObj,successCallback,failureCallback){this._method=method;this._resource=resource;this._jsonObj=jsonObj;this._paramsObj=paramsObj;this._successCallback=successCallback;this._failureCallback=failureCallback},clearAll:function(){this._method=null;this._resource=null;this._jsonObj={};this._paramsObj={};this._successCallback=null;this._failureCallback=null},getMethod:function(){return this._method},setMethod:function(method){this._method=method},getResource:function(){return this._resource},setResource:function(resource){this._resource=resource},getJsonObj:function(){return this._jsonObj},setJsonObj:function(jsonObj){this._jsonObj=jsonObj},getQueryParams:function(){return this._paramsObj},setQueryParams:function(paramsObj){this._paramsObj=paramsObj},getSuccessCallback:function(){return this._successCallback},setSuccessCallback:function(successCallback){this._successCallback=successCallback},callSuccessCallback:function(response){if(this._successCallback&&typeof(this._successCallback)=="function"){this._successCallback(response);return true}else{return false}},getFailureCallback:function(){return this._failureCallback},setFailureCallback:function(failureCallback){this._failureCallback=failureCallback},callFailureCallback:function(response){if(this._failureCallback&&typeof(this._failureCallback)=="function"){this._failureCallback(response);return true}else{return false}},getCurl:function(){return this._curl},setCurl:function(curl){this._curl=curl},getToken:function(){return this._token},setToken:function(token){this._token=token},resetPaging:function(){this._previous=[];this._next=null;this._cursor=null},hasPrevious:function(){return(this._previous.length>0)},getPrevious:function(){this._next=null;this._cursor=this._previous.pop()},hasNext:function(){return(this._next)},getNext:function(){this._previous.push(this._cursor);this._cursor=this._next},saveCursor:function(cursor){if(this._next!=cursor){this._next=cursor}},getCursor:function(){return this._cursor}}})(Usergrid);(function(){Usergrid.Entity=function(collectionType,uuid){this._collectionType=collectionType;this._data={};this._uuid=uuid};Usergrid.Entity.prototype=new Usergrid.Query();Usergrid.Entity.prototype.getCollectionType=function(){return this._collectionType}Usergrid.Entity.prototype.setCollectionType=function(collectionType){this._collectionType=collectionType}Usergrid.Entity.prototype.get=function(field){if(field){return this._data[field]}else{return this._data}},Usergrid.Entity.prototype.set=function(item,value){if(typeof item=='object'){for(field in item){this._data[field]=item[field]}}else if(typeof item=='string'){this._data[item]=value}else{this._data=null}}Usergrid.Entity.prototype.save=function(successCallback,errorCallback){var path=this.getCollectionType();var method='POST';if(this.get('uuid')){method='PUT';if(Usergrid.validation.isUUID(this.get('uuid'))){path+="/"+this.get('uuid')}}var data={};if(path=='users'){data=this.get();var pwdata={};if(data.oldpassword&&data.newpassword){pwdata.oldpassword=data.oldpassword;pwdata.newpassword=data.newpassword;this.runAppQuery(new Usergrid.Query('PUT','users/'+uuid+'/password',pwdata,null,function(response){},function(response){}))}delete data.oldpassword;delete data.newpassword}var self=this;data={};var entityData=this.get();for(var item in entityData){if(item=='metadata'||item=='created'||item=='modified'||item=='type'||item=='activatted'){continue}data[item]=entityData[item]}this.setAllQueryParams(method,path,data,null,function(response){try{var entity=response.entities[0];self.set(entity);if(typeof(successCallback)=="function"){successCallback(response)}}catch(e){if(typeof(errorCallback)=="function"){errorCallback(response)}}},function(response){if(typeof(errorCallback)=="function"){errorCallback(response)}});Usergrid.ApiClient.runAppQuery(this)}Usergrid.Entity.prototype.fetch=function(successCallback,errorCallback){var path=this.getCollectionType();if(this.get('uuid')){path+="/"+this.get('uuid')}else{if(path=="users"){if(this.get("username")){path+="/"+this.get("username")}else{console.log('no username specified');if(typeof(errorCallback)=="function"){console.log('no username specified')}}}else{if(this.get()){path+="/"+this.get()}else{console.log('no entity identifier specified');if(typeof(errorCallback)=="function"){console.log('no entity identifier specified')}}}}var self=this;this.setAllQueryParams('GET',path,null,null,function(response){try{if(response.user){self.set(response.user)}var entity=response.entities[0];self.set(entity);if(typeof(successCallback)=="function"){successCallback(response)}}catch(e){if(typeof(errorCallback)=="function"){errorCallback(response)}}},function(response){if(typeof(errorCallback)=="function"){errorCallback(response)}});Usergrid.ApiClient.runAppQuery(this)}Usergrid.Entity.prototype.destroy=function(successCallback,errorCallback){var path=this.getCollectionType();if(this.get('uuid')){path+="/"+this.get('uuid')}else{console.log('Error trying to delete object - no uuid specified.');if(typeof(errorCallback)=="function"){errorCallback('Error trying to delete object - no uuid specified.')}}var self=this;this.setAllQueryParams('DELETE',path,null,null,function(response){self.set(null);if(typeof(successCallback)=="function"){successCallback(response)}},function(response){if(typeof(errorCallback)=="function"){errorCallback(response)}});Usergrid.ApiClient.runAppQuery(this)}})(Usergrid);(function(){Usergrid.Collection=function(path,uuid){this._path=path;this._uuid=uuid;this._list=[];this._Query=new Usergrid.Query();this._iterator=-1};Usergrid.Collection.prototype=new Usergrid.Query();Usergrid.Collection.prototype.getPath=function(){return this._path}Usergrid.Collection.prototype.setPath=function(path){this._path=path}Usergrid.Collection.prototype.getUUID=function(){return this._uuid}Usergrid.Collection.prototype.setUUID=function(uuid){this._uuid=uuid}Usergrid.Collection.prototype.addEntity=function(entity){var count=this._list.length;this._list[count]=entity}Usergrid.Collection.prototype.addNewEntity=function(entity,successCallback,errorCallback){this.addEntity(entity);entity.save(successCallback,errorCallback)}Usergrid.Collection.prototype.destroyEntity=function(entity){var uuid=entity.get('uuid');if(Usergrid.validation.isUUID(uuid)){var count=this._list.length;var i=0;var reorder=false;for(i=0;i<count;i++){if(reorder){this._list[i-1]=this._list[i];this._list[i]=null}if(this._list[i].get('uuid')==uuid){this._list[i]=null;reorder=true}}}entity.destroy()}Usergrid.Collection.prototype.getEntityByField=function(field,value){var count=this._list.length;var i=0;for(i=0;i<count;i++){if(this._list[i].getField(field)==value){return this._list[i]}}return null}Usergrid.Collection.prototype.getEntityByUUID=function(UUID){var count=this._list.length;var i=0;for(i=0;i<count;i++){if(this._list[i].get('uuid')==UUID){return this._list[i]}}return null}Usergrid.Collection.prototype.getFirstEntity=function(){var count=this._list.length;if(count>0){return this._list[0]}return null}Usergrid.Collection.prototype.getLastEntity=function(){var count=this._list.length;if(count>0){return this._list[count-1]}return null}Usergrid.Collection.prototype.hasNextEntity=function(){var next=this._iterator+1;if(next>=0&&next<this._list.length){return true}return false}Usergrid.Collection.prototype.getNextEntity=function(){this._iterator++;if(this._iterator>=0&&this._iterator<=this._list.length){return this._list[this._iterator]}return false}Usergrid.Collection.prototype.hasPreviousEntity=function(){var previous=this._iterator-1;if(previous>=0&&previous<this._list.length){return true}return false}Usergrid.Collection.prototype.getPreviousEntity=function(){this._iterator--;if(this._iterator>=0&&this._iterator<=this._list.length){return this.list[this._iterator]}return false}Usergrid.Collection.prototype.resetEntityPointer=function(){this._iterator=-1}Usergrid.Collection.prototype.getEntityList=function(){return this._list}Usergrid.Collection.prototype.setEntityList=function(list){this._list=list}Usergrid.Collection.prototype.hasNextPage=function(){return this.hasNext()}Usergrid.Collection.prototype.getNextPage=function(){if(this.hasNext()){this.getNext();this.setEntityList([]);Usergrid.ApiClient.runAppQuery(this)}}Usergrid.Collection.prototype.hasPreviousPage=function(){return this.hasPrevious()}Usergrid.Collection.prototype.getPreviousPage=function(){if(this.hasPrevious()){this.getPrevious();this.setEntityList([]);Usergrid.ApiClient.runAppQuery(this)}}Usergrid.Collection.prototype.clearQuery=function(){this.clearAll()}Usergrid.Collection.prototype.get=function(successCallback,errorCallback){var self=this;var queryParams=this.getQueryParams();this.setEntityList([]);this.setAllQueryParams('GET',this.getPath(),null,queryParams,function(response){if(response.entities){this.resetEntityPointer();var count=response.entities.length;for(var i=0;i<count;i++){var uuid=response.entities[i].uuid;if(uuid){var entity=new Usergrid.Entity(self.getPath(),uuid);var data=response.entities[i]||{};delete data.uuid;entity.set(data);self.addEntity(entity)}}if(typeof(successCallback)=="function"){successCallback(response)}}else{if(typeof(errorCallback)=="function"){errorCallback(response)}}},function(response){if(typeof(errorCallback)=="function"){errorCallback(response)}});Usergrid.ApiClient.runAppQuery(this)}Usergrid.Collection.prototype.save=function(successCallback,errorCallback){var entities=this.getEntityList();var count=entities.length;var jsonObj=[];for(var i=0;i<count;i++){entity=entities[i];data=entity.get();if(entity.get('uuid')){data.uuid=entity.get('uuid');jsonObj.push(data)}entity.save()}this.setAllQueryParams('PUT',this.getPath(),jsonObj,null,successCallback,errorCallback);Usergrid.ApiClient.runAppQuery(this)}})(Usergrid);Usergrid.M='ManagementQuery';Usergrid.A='ApplicationQuery';Usergrid.ApiClient=(function(){var _apiUrl="https://api.usergrid.com/";var _orgName=null;var _appName=null;var _token=null;var _callTimeout=30000;var _queryType=null;var _loggedInUser=null;var _logoutCallback=null;function init(orgName,appName){this.setOrganizationName(orgName);this.setApplicationName(appName)}function runAppQuery(Query){var endpoint="/"+this.getOrganizationName()+"/"+this.getApplicationName()+"/";setQueryType(Usergrid.A);run(Query,endpoint,self)}function runManagementQuery(Query){var endpoint="/management/";setQueryType(Usergrid.M);run(Query,endpoint,self)}function getOrganizationName(){return _orgName}function setOrganizationName(orgName){_orgName=orgName}function getApplicationName(){return _appName}function setApplicationName(appName){_appName=appName}function getToken(){return _token}function setToken(token){_token=token}function getApiUrl(){return _apiUrl}function setApiUrl(apiUrl){_apiUrl=apiUrl}function getCallTimeout(){return _callTimeout}function setCallTimeout(callTimeout){_callTimeout=callTimeout}function getResetPasswordUrl(){return getApiUrl()+"/management/users/resetpw"}function getLoggedInUser(){return this._loggedInUser}function setLoggedInUser(user){this._loggedInUser=user}function logInAppUser(username,password,successCallback,failureCallback){var self=this;var data={"username":username,"password":password,"grant_type":"password"};this.runAppQuery(new Usergrid.Query('GET','token',null,data,function(response){var user=new Usergrid.Entity('users');user.set('username',response.user.username);user.set('name',response.user.name);user.set('email',response.user.email);user.set('uuid',response.user.uuid);self.setLoggedInUser(user);self.setToken(response.access_token);if(successCallback&&typeof(successCallback)=="function"){successCallback(response)}},function(response){if(failureCallback&&typeof(failureCallback)=="function"){failureCallback(response)}}))}function renewAppUserToken(){}function logoutAppUser(){this.setLoggedInUser(null);this.setToken(null)}function isLoggedInAppUser(){var user=this.getLoggedInUser();return(this.getToken()&&Usergrid.validation.isUUID(user.get('uuid')))}function getLogoutCallback(){return _logoutCallback}function setLogoutCallback(logoutCallback){_logoutCallback=logoutCallback}function callLogoutCallback(){if(_logoutCallback&&typeof(_logoutCallback)=="function"){_logoutCallback();return true}else{return false}}function encodeParams(params){tail=[];var item=[];if(params instanceof Array){for(i in params){item=params[i];if((item instanceof Array)&&(item.length>1)){tail.push(item[0]+"="+encodeURIComponent(item[1]))}}}else{for(var key in params){if(params.hasOwnProperty(key)){var value=params[key];if(value instanceof Array){for(i in value){item=value[i];tail.push(key+"="+encodeURIComponent(item))}}else{tail.push(key+"="+encodeURIComponent(value))}}}}return tail.join("&")}function getQueryType(){return _queryType}function setQueryType(type){_queryType=type}function run(Query,endpoint){var curl="curl";try{if(!(Query instanceof Usergrid.Query)){throw(new Error('Query is not a valid object.'))}Query.setQueryStartTime();var method=Query.getMethod().toUpperCase();var path=Query.getResource();var jsonObj=Query.getJsonObj()||{};var params=Query.getQueryParams()||{};if(method!='GET'&&method!='POST'&&method!='PUT'&&method!='DELETE'){throw(new Error('Invalid method - should be GET, POST, PUT, or DELETE.'))}if(method=="POST"){curl+=" -X POST"}else if(method=="PUT"){curl+=" -X PUT"}else if(method=="DELETE"){curl+=" -X DELETE"}else{curl+=" -X GET"}var application_name=Usergrid.ApiClient.getApplicationName();if(application_name){application_name=application_name.toUpperCase()}if((application_name!='SANDBOX'&&Usergrid.ApiClient.getToken())||(getQueryType()==Usergrid.M&&Usergrid.ApiClient.getToken())){curl+=' -i -H "Authorization: Bearer '+Usergrid.ApiClient.getToken()+'"';Query.setToken(true)}_params=JSON.stringify(params);if(!JSON.parse(_params)){throw(new Error('Params object is not valid.'))}if(Query.getCursor()){params.cursor=Query.getCursor()}else{delete params.cursor}endpoint=endpoint.indexOf('/')==0?endpoint.substring(1):endpoint;path=endpoint+path;if(path){while(path.indexOf('//')!=-1){path=path.replace('//','/')}}path=Usergrid.ApiClient.getApiUrl()+path;curl+=' "'+path;var curl_encoded_params=encodeParams(params);if(curl_encoded_params){curl+="?"+curl_encoded_params}curl+='"';if((method=="GET")||(method=="DELETE")){params['_']=new Date().getTime()}var encoded_params=encodeParams(params);if(encoded_params){path+="?"+encoded_params}jsonObj=JSON.stringify(jsonObj)if(!JSON.parse(jsonObj)){throw(new Error('JSON object is not valid.'))}if(jsonObj=='{}'){jsonObj=null}else{curl+=" -d '"+jsonObj+"'"}}catch(e){console.log('error occured running query -'+e.message);return false}console.log(curl);Query.setCurl(curl);var xD=window.XDomainRequest?true:false;var xhr=getXHR(method,path,jsonObj);xhr.onerror=function(){Query.setQueryEndTime();console.log(Query.getQueryTotalTime());clearTimeout(timeout);console.log('API call failed at the network level.');Query.callFailureCallback(response.innerText)};xhr.xdomainOnload=function(response){Query.setQueryEndTime();console.log('Call timing: '+Query.getQueryTotalTime());clearTimeout(timeout);response=JSON.parse(xhr.responseText);try{var cursor=response.cursor||null;Query.saveCursor(cursor)}catch(e){}Query.callSuccessCallback(response)};xhr.onload=function(response){Query.setQueryEndTime();console.log('Call timing: '+Query.getQueryTotalTime());clearTimeout(timeout);response=JSON.parse(xhr.responseText);if(xhr.status!=200&&!xD){try{var error=response.error;console.log('API call failed: (status: '+xhr.status+').'+error.type);if((error.type=="auth_expired_session_token")||(error.type=="unauthorized")||(error.type=="auth_missing_credentials")||(error.type=="auth_invalid")){callLogoutCallback()}}catch(e){}Query.callFailureCallback(response.error_description);return}else{var cursor=response.cursor||null;Query.saveCursor(cursor);Query.callSuccessCallback(response)}};var timeout=setTimeout(function(){xhr.abort();Query.callFailureCallback('API CALL TIMEOUT')},Usergrid.ApiClient.getCallTimeout());xhr.send(jsonObj)}function getXHR(method,path,jsonObj){var xhr;if(window.XDomainRequest){xhr=new window.XDomainRequest();if(Usergrid.ApiClient.getToken()){if(path.indexOf("?")){path+='&access_token='+Usergrid.ApiClient.getToken()}else{path='?access_token='+Usergrid.ApiClient.getToken()}}xhr.open(method,path,true)}else{xhr=new XMLHttpRequest();xhr.open(method,path,true);if(jsonObj){xhr.setRequestHeader("Content-Type","application/json")}if(Usergrid.ApiClient.getToken()){xhr.setRequestHeader("Authorization","Bearer "+Usergrid.ApiClient.getToken());xhr.withCredentials=true}}return xhr}return{init:init,runAppQuery:runAppQuery,runManagementQuery:runManagementQuery,getOrganizationName:getOrganizationName,setOrganizationName:setOrganizationName,getApplicationName:getApplicationName,setApplicationName:setApplicationName,getToken:getToken,setToken:setToken,getCallTimeout:getCallTimeout,setCallTimeout:setCallTimeout,getApiUrl:getApiUrl,setApiUrl:setApiUrl,getResetPasswordUrl:getResetPasswordUrl,getLoggedInUser:getLoggedInUser,setLoggedInUser:setLoggedInUser,logInAppUser:logInAppUser,renewAppUserToken:renewAppUserToken,logoutAppUser:logoutAppUser,isLoggedInAppUser:isLoggedInAppUser,getLogoutCallback:getLogoutCallback,setLogoutCallback:setLogoutCallback,callLogoutCallback:callLogoutCallback}})();Usergrid.validation=(function(){var usernameRegex=new RegExp("^([0-9a-zA-Z\.\-])+$");var nameRegex=new RegExp("^([0-9a-zA-Z@#$%^&!?;:.,'\"~*-=+_\[\\](){}/\\ |])+$");var emailRegex=new RegExp("^(([0-9a-zA-Z]+[_\+.-]?)+@[0-9a-zA-Z]+[0-9,a-z,A-Z,.,-]*(.){1}[a-zA-Z]{2,4})+$");var passwordRegex=new RegExp("^([0-9a-zA-Z@#$%^&!?<>;:.,'\"~*-=+_\[\\](){}/\\ |])+$");var pathRegex=new RegExp("^([0-9a-z./-])+$");var titleRegex=new RegExp("^([0-9a-zA-Z.!-?/])+$");function validateUsername(username,failureCallback){if(usernameRegex.test(username)&&checkLength(username,4,80)){return true}else{if(failureCallback&&typeof(failureCallback)=="function"){failureCallback(this.getUsernameAllowedChars())}return false}}function getUsernameAllowedChars(){return'Length: min 4, max 80. Allowed: A-Z, a-z, 0-9, dot, and dash'}function validateName(name,failureCallback){if(nameRegex.test(name)&&checkLength(name,4,16)){return true}else{if(failureCallback&&typeof(failureCallback)=="function"){failureCallback(this.getNameAllowedChars())}return false}}function getNameAllowedChars(){return'Length: min 4, max 80. Allowed: A-Z, a-z, 0-9, ~ @ # % ^ & * ( ) - _ = + [ ] { } \\ | ; : \' " , . / ? !'}function validatePassword(password,failureCallback){if(passwordRegex.test(password)&&checkLength(password,5,16)){return true}else{if(failureCallback&&typeof(failureCallback)=="function"){failureCallback(this.getPasswordAllowedChars())}return false}}function getPasswordAllowedChars(){return'Length: min 5, max 16. Allowed: A-Z, a-z, 0-9, ~ @ # % ^ & * ( ) - _ = + [ ] { } \\ | ; : \' " , . < > / ? !'}function validateEmail(email,failureCallback){if(emailRegex.test(email)&&checkLength(email,4,80)){return true}else{if(failureCallback&&typeof(failureCallback)=="function"){failureCallback(this.getEmailAllowedChars())}return false}}function getEmailAllowedChars(){return'Email must be in standard form: e.g. example@Usergrid.com'}function validatePath(path,failureCallback){if(pathRegex.test(path)&&checkLength(path,4,80)){return true}else{if(failureCallback&&typeof(failureCallback)=="function"){failureCallback(this.getPathAllowedChars())}return false}}function getPathAllowedChars(){return'Length: min 4, max 80. Allowed: /, a-z, 0-9, dot, and dash'}function validateTitle(title,failureCallback){if(titleRegex.test(title)&&checkLength(title,4,80)){return true}else{if(failureCallback&&typeof(failureCallback)=="function"){failureCallback(this.getTitleAllowedChars())}return false}}function getTitleAllowedChars(){return'Length: min 4, max 80. Allowed: space, A-Z, a-z, 0-9, dot, dash, /, !, and ?'}function checkLength(string,min,max){if(string.length>max||string.length<min){return false}return true}function isUUID(uuid){var uuidValueRegex=/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/;if(!uuid)return false;return uuidValueRegex.test(uuid)}return{validateUsername:validateUsername,getUsernameAllowedChars:getUsernameAllowedChars,validateName:validateName,getNameAllowedChars:getNameAllowedChars,validatePassword:validatePassword,getPasswordAllowedChars:getPasswordAllowedChars,validateEmail:validateEmail,getEmailAllowedChars:getEmailAllowedChars,validatePath:validatePath,getPathAllowedChars:getPathAllowedChars,validateTitle:validateTitle,getTitleAllowedChars:getTitleAllowedChars,isUUID:isUUID}})();